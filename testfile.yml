---
AWSTemplateFormatVersion: '2010-09-09'
Description: Cloudformation template to deploy a ECS cluster using CI/CD Pipeline
Parameters:
  VpcCIDR:
    Type: String
    Default: 18.0.0.0/16
    Description: CIDR block for the VPC

  PublicSubnet1CIDR:
    Type: String
    Default: 18.0.0.0/24
    Description: CIDR block for the public subnet

  PrivateSubnet1CIDR:
    Type: String
    Default: 18.0.1.0/24
    Description: CIDR block for the private subnet

  PublicSubnet2CIDR:
    Type: String
    Default: 18.0.2.0/24
    Description: CIDR block for the public subnet

  PrivateSubnet2CIDR:
    Type: String
    Default: 18.0.3.0/24
    Description: CIDR block for the private subnet

  GitHubOwner:
    Description: Name of GitHub Owner
    Type: String
    Default: hammadkhaliq566

  GitHubRepo:
    Description: Name of GitHub Repo
    Type: String
    Default: AWS-ECS-Project

  GitHubBranch:
    Description: Name of GitHub Repo Branch
    Type: String
    Default: main

  GitHubOAuthToken:
    Type: String
    NoEcho: true
    Default: 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

  CodePipelineRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: 
                - codepipeline.amazonaws.com
                - codebuild.amazonaws.com
            Action: 'sts:AssumeRole'
      Policies:
        - PolicyName: CodePipelinePolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Resource:
                  - 'arn:aws:logs:us-east-1:433337163311:log-group:/aws/codebuild/demo'
                  - 'arn:aws:logs:us-east-1:433337163311:log-group:/aws/codebuild/demo:*'
                  - '*'
                Action:
                  - 'logs:CreateLogGroup'
                  - 'logs:CreateLogStream'
                  - 'logs:PutLogEvents'
              - Effect: Allow
                Resource:
                  - 'arn:aws:s3:::ecs-deployment-devops-project*'
                  - 'arn:aws:s3:::ecs-deployment-devops-project-*/*'
                Action:
                  - 's3:PutObject'
                  - 's3:GetObject'
                  - 's3:GetObjectVersion'
                  - 's3:GetBucketAcl'
                  - 's3:GetBucketLocation'
                  - 's3:*'
              - Effect: Allow
                Action:
                  - 'ecr:GetAuthorizationToken'
                  - 'ecr:GetDownloadUrlForLayer'
                  - 'ecr:BatchCheckLayerAvailability'
                  - 'ecr:GetRepositoryPolicy'
                  - 'ecr:DescribeRepositories'
                  - 'ecr:ListImages'
                  - 'ecr:DescribeImages'
                  - 'ecr:BatchGetImage'
                  - 'ecr:GetLifecyclePolicy'
                  - 'ecr:GetLifecyclePolicyPreview'
                  - 'ecr:GetRepositoryPolicyPreview'
                  - 'ecr:PutLifecyclePolicy'
                  - 'ecr:PutImageTagMutability'
                  - 'ecr:PutImage'
                  - 'ecr:PutImageScanningConfiguration'
                  - 'ecr:StartImageScan'
                  - 'ecr:BatchDeleteImage'
                Resource: '*'
              - Effect: Allow
                Action:
                  - 'codebuild:CreateReportGroup'
                  - 'codebuild:CreateReport'
                  - 'codebuild:UpdateReport'
                  - 'codebuild:BatchPutTestCases'
                  - 'codebuild:BatchPutCodeCoverages'
                Resource:
                  - 'arn:aws:codebuild:us-east-1:433337163311:report-group/demo-*'
              - Effect: Allow
                Action: 'codebuild:StartBuild'
                Resource: 'arn:aws:codebuild:us-east-1::project/CodeBuildProject'

  CodeBuildProject:
    Type: AWS::CodeBuild::Project
    Properties:
      Name: CodeBuildProject
      ServiceRole: !Ref CodePipelineRole
      Source:
        Type: GITHUB
        Location: https://github.com/hammadkhaliq566/AWS-ECS-Project.git
        BuildSpec: buildspec.yml
      Artifacts:
        Type: NO_ARTIFACTS
      Environment:
        Type: LINUX_CONTAINER
        ComputeType: BUILD_GENERAL1_SMALL
        Image: aws/codebuild/amazonlinux2-x86_64-standard:4.0
        PrivilegedMode: true

  CodeDeployServiceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: codedeploy.amazonaws.com
            Action: 'sts:AssumeRole'
      Policies:
        - PolicyName: CodeDeployServiceRolePolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - 'ecs:DescribeServices'
                  - 'ecs:UpdateService'
                Resource: !Sub 'arn:aws:ecs:${AWS::Region}:${AWS::AccountId}:service/ECSCluster/*'

  GithubWebhook:
    Type: AWS::CodePipeline::Webhook
    Properties:
      Authentication: GITHUB_HMAC
      AuthenticationConfiguration:
          SecretToken: !Ref GitHubOAuthToken
      RegisterWithThirdParty: true
      Filters:
      - JsonPath: "$.ref"
        MatchEquals: refs/heads/{Branch}
      TargetPipeline: !Ref CodePipeline
      TargetPipelineVersion: !GetAtt CodePipeline.Version
      TargetAction: Source

  CodePipeline:
    Type: AWS::CodePipeline::Pipeline
    Properties:
      Name: GluePipeline
      ArtifactStore:
        Type: S3
        Location: !Sub ${BuckerName}
      RestartExecutionOnUpdate: true
      RoleArn: !GetAtt CodePipelineRole.Arn
      Stages:
      - Name: Source
        Actions:
        - Name: Source
          InputArtifacts: []
          ActionTypeId:
            Category: Source
            Owner: ThirdParty
            Version: 1
            Provider: GitHub
          OutputArtifacts:
          - Name: SourceCode
          Configuration:
            Owner: !Ref GitHubOwner
            Repo: !Ref GitHubRepo
            Branch: !Ref GitHubBranch
            PollForSourceChanges: false
            OAuthToken: !Ref GitHubOAuthToken
          RunOrder: 1
      - Name: Build
        Actions:
          - Name: BuildAction
            ActionTypeId:
              Category: Build
              Owner: AWS
              Version: '1'
              Provider: CodeBuild
            InputArtifacts:
              - Name: SourceCode
            Configuration:
              ProjectName: !Ref CodeBuildProject
            OutputArtifacts:
              - Name: BuildOutput


  CodeDeployApplication:
    Type: AWS::CodeDeploy::Application
    Properties:
      ApplicationName: ECSDeploymentApp
      ComputePlatform: ECS

  CodeDeployDeploymentGroup:
    Type: AWS::CodeDeploy::DeploymentGroup
    Properties:
      applicationName: TestCodeDeployApplication
      autoRollbackConfiguration:
        enabled: true
        events:
        - DEPLOYMENT_FAILURE
      blueGreenDeploymentConfiguration:
        deploymentReadyOption:
          actionOnTimeout: CONTINUE_DEPLOYMENT
          waitTimeInMinutes: 0
        terminateBlueInstancesOnDeploymentSuccess:
          action: TERMINATE
          terminationWaitTimeInMinutes: 5
      deploymentGroupName: TestCodeDeployDeploymentGroup
      deploymentStyle:
        deploymentOption: WITH_TRAFFIC_CONTROL
        deploymentType: BLUE_GREEN
      loadBalancerInfo:
        targetGroupPairInfoList:
        - targetGroups:
          - name: TargetGroup01
          - name: TargetGroup02
          prodTrafficRoute:
            listenerArns:
            - arn:aws:elasticloadbalancing:us-east-1:174304792831:listener/app/TestALB/a8cafcec8f307a78/02c89168206f1d21
      serviceRoleArn: arn:aws:iam::174304792831:role/service-role/CodeDeployServiceRole
      ecsServices:
      - serviceName: PostCodeECSService
        clusterName: TestECSCluster


      - Name: Deploy
        Actions:
          - Name: DeployAction
            ActionTypeId:
              Category: Deploy
              Owner: AWS
              Version: '1'
              Provider: ECS
            InputArtifacts:
              - Name: SourceCode
            Configuration:
              ClusterName: !Ref ECSCluster
              ServiceName: !Ref ECSService


